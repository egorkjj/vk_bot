import vk_api
from vk_api.keyboard import VkKeyboard, VkKeyboardColor
from vk_api.longpoll import VkLongPoll, VkEventType
from environs import Env
from DBSM import user_step_change, all_link, user_step_check, for_th, loop, disable_messages, is_disabled
from aiogram import Bot
from threading import Thread as th
import asyncio
import requests
import time




async def vk_apply() -> None:
    while True:
        try:
            #read env
            env = Env()
            env.read_env(".env")
            token = env.str("API_KEY")
            bot_token = env.str("BOT_TOKEN")

            # —Ç–≥ –±–æ—Ç
            bot = Bot(token=bot_token, parse_mode = 'HTML')

            # –ø–∏—à–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            def write_msg(user_id, message, kb) -> None:
                vk.method('messages.send', {'user_id': user_id, 'message': message, "random_id": 0, "keyboard": kb})

            #–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
            def create_kb(text) -> str:
                keyboard = VkKeyboard(inline=True)
                keyboard.add_button(f'{text}', color= VkKeyboardColor.POSITIVE)
                return keyboard.get_keyboard()
            
            #–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–≤—É—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —à–∞–≥–æ–≤
            def create_last_kb(text) -> str:
                keyboard = VkKeyboard(inline=True)
                keyboard.add_button("–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—è–º", color = VkKeyboardColor.POSITIVE)
                keyboard.add_button(f'{text}', color= VkKeyboardColor.POSITIVE)
                return keyboard.get_keyboard()
            
            def create_–æff_kb(text) -> str:
                keyboard = VkKeyboard(inline=True)
                keyboard.add_button("–ù–∞–∑–∞–¥", color = VkKeyboardColor.POSITIVE)
                keyboard.add_button(f'{text}', color= VkKeyboardColor.POSITIVE)
                return keyboard.get_keyboard()
            
            #–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ
            def send_photo(id, text, kb) -> None:
                a = vk.method("photos.getMessagesUploadServer")
                b = requests.post(a['upload_url'], files={'photo': open('fotor.png', 'rb')}).json()
                c = vk.method('photos.saveMessagesPhoto', {'photo': b['photo'], 'server': b['server'], 'hash': b['hash']})[0]
                d = "photo{}_{}".format(c["owner_id"], c["id"])
                vk.method("messages.send", {"user_id": id, "message": text, "attachment": d, "random_id": 0, "keyboard": kb})

            #—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Å—ã–ª–æ–∫ –¥–ª—è –æ—Ñ—Ñ–µ—Ä–æ–≤
            def links_text() -> str:
                data = all_link()
                text = ""
                for i in data:
                    text += f"\n{i}\n\n"
                return text

            # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
            vk = vk_api.VkApi(token=token)
            api = vk.get_api()

            #—Ä–∞—Å—Å—ã–ª–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            def sent_for_th(user_id, user_name):
                if not for_th(user_name):
                    return
                time.sleep(86400)
                if user_step_check(user_name) == 10:
                    return
                if user_step_check(user_name) != 7:
                    disable_messages(user_name)
                    links = links_text()
                    write_msg(user_id, f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, —Ä–∞–Ω–µ–µ –≤—ã –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å –æ–Ω–ª–∞–π–Ω –∑–∞—Ä–∞–±–æ—Ç–∫–æ–º –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ WorkPoint, –≤—ã—Å—ã–ª–∞–µ–º –≤–∞–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π, –≤—ã–ø–ª–∞—Ç—É –∑–∞ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è:\n{links}", None)
                else:
                    disable_messages(user_name)
                    write_msg(user_id, f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, —Ä–∞–Ω–µ–µ –≤—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –æ–Ω–ª–∞–π–Ω –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏ WorkPoint, –ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ, —É–¥–∞–ª–æ—Å—å –ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—ã?", None)
            
            # –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            longpoll = VkLongPoll(vk)

            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
            for event in longpoll.listen():

                # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if event.type == VkEventType.MESSAGE_NEW:
                    # if message is to me
                    if event.to_me:
                        # message.text
                        request = event.text

                        # user_array and username
                        user = api.users.get(user_ids= event.user_id, fields = "screen_name")
                        name_short = user[0].get("screen_name")

                        #—à–∞–≥, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–µ–π—á–∞—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –≤–æ—Ä–æ–Ω–∫–µ
                        step = user_step_check(name_short)

                        # processing_messages
                        if request == "–ù–∞—á–∞—Ç—å":  #step2
                            user_step_change(name_short, 2)
                            loop(name_short,2)
                            th(target = sent_for_th, args=(event.user_id, name_short)).start()
                            text = f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {user[0]['first_name']}üëã\n\n–ú—ã —Ä–µ–∫–ª–∞–º–Ω–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Å—Ñ–µ—Ä–µ, –∫–æ—Ç–æ—Ä–æ–µ –¥–∞–µ—Ç —Å–≤–æ–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω.\n\nüí¨ –í—ã –º–æ–∂–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –æ—Ç–∑—ã–≤–∞–º–∏ –æ —Ä–∞–±–æ—Ç–µ —Å –Ω–∞–º–∏, –≤—ã –ª–∏—á–Ω–æ –º–æ–∂–µ—Ç–µ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –ª—é–±—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–æ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞—à–∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤:\nüëâ https://vk.com/topic-226064276_51178194\n\n–î–æ –ø–µ—Ä–≤–æ–π –≤—ã–ø–ª–∞—Ç—ã –æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ 3 —à–∞–≥–∞!"
                            send_photo(event.user_id, text, create_kb("–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—åüë®‚Äçüíª"))

                        elif request == "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—åüë®‚Äçüíª":  #step3
                            loop(name_short,3)
                            user_step_change(name_short, 3)
                            text = "–ö–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —É–∂–µ –°–ï–ì–û–î–ù–Øüëá\n\nüìç –°—É—Ç—å –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏:\n\n‚Äî –í—ã –æ—Ñ–æ—Ä–º–ª—è–π—Ç–µ –ë–ï–°–ü–õ–ê–¢–ù–´–ï –ø—Ä–æ–¥—É–∫—Ç—ã –±–∞–Ω–∫–∞, –ø–æ –Ω–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n‚Äî –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ–±–µ—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–∏, –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –∑–∞–∫–∞–∑–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Å—Ç—É–ø–∏—Ç –≤–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.\n‚Äî –í—ã –Ω–∏—á–µ–º –Ω–µ —Ä–∏—Å–∫—É–π—Ç–µ –∏ –Ω–∏–∫–∞–∫–∏—Ö –≤–ª–æ–∂–µ–Ω–∏–π.\n\n–ë–∞–Ω–∫–∏ –ø–ª–∞—Ç—è—Ç, —á—Ç–æ–±—ã –≤—ã –∑–∞–≤–µ–ª–∏ –∏—Ö –¥–µ–±–µ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É, –∞ –º—ã –¥–µ–ª–∏–º—Å—è —Å –í–∞–º–∏!üí∂\n\n–û–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É –≤ –¥–µ–Ω—å –ø–æ–ª—É—á–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –ø–µ—Ä–µ–≤–æ–¥–æ–º!\n\n–í—ã –ø–æ–ª—É—á–∞–π—Ç–µ –æ–ø–ª–∞—Ç—É –æ—Ç 500‚ÇΩ - 15 000‚ÇΩ, –ø–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –ª—é–±–æ–π –±–∞–Ω–∫, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª-–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.\n\n–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Å 8:00 - 22:00 –ø–æ –ú–°–ö!\n\n‚úÖ –õ–µ–≥–∞–ª—å–Ω–∞—è –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –†–§!\n\n–î–æ –ø–µ—Ä–≤–æ–π –≤—ã–ø–ª–∞—Ç—ã –æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ 2 —à–∞–≥–∞!"
                            write_msg(event.user_id, text, create_kb("–î–∞–ª–µ–µ"))

                        elif request == "–î–∞–ª–µ–µ":  #step4
                            loop(name_short,4)
                            user_step_change(name_short, 4)
                            text = "üì≤‚öí–ß—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–ª–∞—Ç—å:\n\n1) –ó–∞–∫–∞–∑–∞—Ç—å –ø–æ –Ω–∞—à–∏–º —Å—Å—ã–ª–∫–∞–º –ë–ï–°–ü–õ–ê–¢–ù–´–ï –¥–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã;\n2) –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—ã –≤ —É–¥–æ–±–Ω–æ–º –º–µ—Å—Ç–µ (–¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º –∏–ª–∏ –ø–æ –ª—é–±–æ–º—É —É–¥–æ–±–Ω–æ–º—É –∞–¥—Ä–µ—Å—É);\n3) –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –∏ —Å–æ–æ–±—â–∏—Ç—å –Ω–∞–º;\n4) –ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω–µ–∂–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ!üí∂\n\n–ì–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? –ú—ã —É–∂–µ –ø–æ–¥–æ–±—Ä–∞–ª–∏ –¥–ª—è –í–∞—Å –ø–µ—Ä–≤—ã–µ –∑–∞–¥–∞–Ω–∏—èüëá\n\n–î–æ –ø–µ—Ä–≤–æ–π –≤—ã–ø–ª–∞—Ç—ã –æ—Å—Ç–∞–ª—Å—è –≤—Å–µ–≥–æ 1 —à–∞–≥!"
                            write_msg(event.user_id, text, create_kb("–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è"))

                        elif request == "–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è":  #step5
                            loop(name_short, 5)
                            user_step_change(name_short, 5)
                            links = links_text()
                            text = f"–û—Ç–ª–∏—á–Ω–æ!\n\n–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–πüëá\n\n–ß–µ–º –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç - —Ç–µ–º –±–æ–ª—å—à–µ –æ–ø–ª–∞—Ç–∞.\n\n‚ö† –ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Ö –±–∞–Ω–∫–æ–≤, –∫–ª–∏–µ–Ω—Ç–æ–º –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∏, –∏–Ω–∞—á–µ –æ–ø–ª–∞—Ç—É –Ω–µ –ø–æ–ª—É—á–∏—Ç—å!‚ö†üëâ\n{links}–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É '–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É' –Ω–∏–∂–µ;\n‚Ü™ –î–∞–ª–µ–µ –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–¥–∞–Ω–∏—è–º!\n\n‚ùì–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: https://vk.com/madriot"
                            write_msg(event.user_id, text, create_–æff_kb("–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É"))
                        
                        elif request == "–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É": #step6
                            loop(name_short,6)
                            user_step_change(name_short, 6)
                            text = "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ!\n\n–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –≤–∞—Å —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º, –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ!üíµ\n\nüí¨–ü–æ–∫–∞ –≤–∞—à—É –∫–∞—Ä—Ç—É –≥–æ—Ç–æ–≤—è—Ç –∫ –≤—ã–¥–∞—á–µ, –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∏ –¥—Ä—É–≥–∏–µ –∫–∞—Ä—Ç—ã - –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—è–º¬ªüëá\n\n–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ä—Ç –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞¬ªüëá"
                            write_msg(event.user_id, text, create_last_kb("–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞"))
                        
                        elif request == "–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞":  #step7
                            loop(name_short, 7)
                            user_step_change(name_short, 7)
                            text = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞, –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞–º –≤—ã–ø–ª–∞—Ç—É —Å—Ä–µ–¥—Å—Ç–≤, –≤ —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä üë®‚Äçüíª\n\n–ï—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è —Å–æ–±–ª—é–¥–µ–Ω—ã, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞'üëá"
                            write_msg(event.user_id, text, create_last_kb("–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞"))
                        
                        elif request == "–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞": # !! final step !!
                            loop(name_short,10)
                            #send message with bot
                            await bot.send_message(chat_id = 398346500, text= f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å https://vk.com/{name_short} –æ–∂–∏–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞")
                            user_step_change(name_short, 10)

                        elif request == "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —à–∞–≥—É" or request == "–ù–∞–∑–∞–¥": #–ª–æ–≥–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É
                            if request == "–ù–∞–∑–∞–¥":
                                stepn = step - 1
                            else:
                                stepn = step
                            if stepn == 4:
                                text = "üì≤‚öí–ß—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–ª–∞—Ç—å:\n\n1) –ó–∞–∫–∞–∑–∞—Ç—å –ø–æ –Ω–∞—à–∏–º —Å—Å—ã–ª–∫–∞–º –ë–ï–°–ü–õ–ê–¢–ù–´–ï –¥–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã;\n2) –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—ã –≤ —É–¥–æ–±–Ω–æ–º –º–µ—Å—Ç–µ (–¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º –∏–ª–∏ –ø–æ –ª—é–±–æ–º—É —É–¥–æ–±–Ω–æ–º—É –∞–¥—Ä–µ—Å—É);\n3) –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –∏ —Å–æ–æ–±—â–∏—Ç—å –Ω–∞–º;\n4) –ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω–µ–∂–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ!üí∂\n\n–ì–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? –ú—ã —É–∂–µ –ø–æ–¥–æ–±—Ä–∞–ª–∏ –¥–ª—è –í–∞—Å –ø–µ—Ä–≤—ã–µ –∑–∞–¥–∞–Ω–∏—èüëá"
                                write_msg(event.user_id, text, create_kb("–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è"))
                            elif stepn == 3:
                                text = "–ö–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —É–∂–µ –°–ï–ì–û–î–ù–Øüëá\n\nüìç –°—É—Ç—å –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏:\n\n‚Äî –í—ã –æ—Ñ–æ—Ä–º–ª—è–π—Ç–µ –ë–ï–°–ü–õ–ê–¢–ù–´–ï –ø—Ä–æ–¥—É–∫—Ç—ã –±–∞–Ω–∫–∞, –ø–æ –Ω–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n‚Äî –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ–±–µ—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–∏, –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –∑–∞–∫–∞–∑–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Å—Ç—É–ø–∏—Ç –≤–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.\n‚Äî –í—ã –Ω–∏—á–µ–º –Ω–µ —Ä–∏—Å–∫—É–π—Ç–µ –∏ –Ω–∏–∫–∞–∫–∏—Ö –≤–ª–æ–∂–µ–Ω–∏–π.\n\n–ë–∞–Ω–∫–∏ –ø–ª–∞—Ç—è—Ç, —á—Ç–æ–±—ã –≤—ã –∑–∞–≤–µ–ª–∏ –∏—Ö –¥–µ–±–µ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É, –∞ –º—ã –¥–µ–ª–∏–º—Å—è —Å –í–∞–º–∏!üí∂\n\n–û–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É –≤ –¥–µ–Ω—å –ø–æ–ª—É—á–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –ø–µ—Ä–µ–≤–æ–¥–æ–º!\n\n–í—ã –ø–æ–ª—É—á–∞–π—Ç–µ –æ–ø–ª–∞—Ç—É –æ—Ç 500‚ÇΩ - 15 000‚ÇΩ, –ø–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –ª—é–±–æ–π –±–∞–Ω–∫, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª-–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.\n\n–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Å 8:00 - 22:00 –ø–æ –ú–°–ö!\n\n‚úÖ –õ–µ–≥–∞–ª—å–Ω–∞—è –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –†–§!"
                                write_msg(event.user_id, text, create_kb("–î–∞–ª–µ–µ"))
                            elif stepn == 6:
                                text = "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ!\n\n–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –≤–∞—Å —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º, –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ!üíµ\n\nüí¨–ü–æ–∫–∞ –≤–∞—à—É –∫–∞—Ä—Ç—É –≥–æ—Ç–æ–≤—è—Ç –∫ –≤—ã–¥–∞—á–µ, –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∏ –¥—Ä—É–≥–∏–µ –∫–∞—Ä—Ç—ã - –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—è–º¬ªüëá\n\n–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ä—Ç –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞¬ªüëá"
                                write_msg(event.user_id, text, create_last_kb("–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞"))
                            elif stepn == 7:
                                text = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞, –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞–º –≤—ã–ø–ª–∞—Ç—É —Å—Ä–µ–¥—Å—Ç–≤, –≤ —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä üë®‚Äçüíª\n\n–ï—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è —Å–æ–±–ª—é–¥–µ–Ω—ã, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞'üëá"
                                write_msg(event.user_id, text, create_last_kb("–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞"))
                            elif stepn == 5:
                                links = links_text()
                                text = f"–û—Ç–ª–∏—á–Ω–æ!\n\n–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–πüëá\n\n–ß–µ–º –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç - —Ç–µ–º –±–æ–ª—å—à–µ –æ–ø–ª–∞—Ç–∞.\n\n‚ö† –ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Ö –±–∞–Ω–∫–æ–≤, –∫–ª–∏–µ–Ω—Ç–æ–º –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∏, –∏–Ω–∞—á–µ –æ–ø–ª–∞—Ç—É –Ω–µ –ø–æ–ª—É—á–∏—Ç—å!‚ö†üëâ\n{links}–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É '–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É' –Ω–∏–∂–µ;\n‚Ü™ –î–∞–ª–µ–µ –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–¥–∞–Ω–∏—è–º!\n\n‚ùì–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: https://vk.com/madriot"
                                write_msg(event.user_id, text, create_–æff_kb("–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É"))
                            elif stepn == 0:
                                keyboard = VkKeyboard(one_time=True)
                                keyboard.add_button(f'–ù–∞—á–∞—Ç—å', color= VkKeyboardColor.POSITIVE)
                                write_msg(event.user_id, "–Ø –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ù–∞—á–∞—Ç—å", keyboard.get_keyboard())
                            elif stepn == 2:
                                text = f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {user[0]['first_name']}üëã\n\n–ú—ã —Ä–µ–∫–ª–∞–º–Ω–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Å—Ñ–µ—Ä–µ, –∫–æ—Ç–æ—Ä–æ–µ –¥–∞–µ—Ç —Å–≤–æ–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω.\n\nüí¨ –í—ã –º–æ–∂–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –æ—Ç–∑—ã–≤–∞–º–∏ –æ —Ä–∞–±–æ—Ç–µ —Å –Ω–∞–º–∏, –≤—ã –ª–∏—á–Ω–æ –º–æ–∂–µ—Ç–µ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –ª—é–±—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–æ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞—à–∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤:\nüëâ https://vk.com/topic-226064276_51178194"
                                send_photo(event.user_id, text, create_kb("–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—åüë®‚Äçüíª"))

                        
                        elif request == "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞–Ω–∏–π" or request == "–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—è–º": #–ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ñ—Ñ–µ—Ä–∞–º
                            if step != 0:
                                links = links_text()
                                text = f"–û—Ç–ª–∏—á–Ω–æ!\n\n–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–πüëá\n\n–ß–µ–º –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç - —Ç–µ–º –±–æ–ª—å—à–µ –æ–ø–ª–∞—Ç–∞.\n\n‚ö† –ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Ö –±–∞–Ω–∫–æ–≤, –∫–ª–∏–µ–Ω—Ç–æ–º –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∏, –∏–Ω–∞—á–µ –æ–ø–ª–∞—Ç—É –Ω–µ –ø–æ–ª—É—á–∏—Ç—å!‚ö†üëâ\n{links}–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É '–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É' –Ω–∏–∂–µ;\n‚Ü™ –î–∞–ª–µ–µ –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–¥–∞–Ω–∏—è–º!\n\n‚ùì–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: https://vk.com/madriot"
                                write_msg(event.user_id, text, create_–æff_kb("–Ø –æ—Ñ–æ—Ä–º–∏–ª –∫–∞—Ä—Ç—É"))
                            else:
                                keyboard = VkKeyboard(one_time=True)
                                keyboard.add_button(f'–ù–∞—á–∞—Ç—å', color= VkKeyboardColor.POSITIVE)
                                write_msg(event.user_id, "–Ø –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ù–∞—á–∞—Ç—å", keyboard.get_keyboard())
                        
                        else: #–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ª–µ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                            if is_disabled(name_short):
                                continue
                            if step == 0:
                                keyboard = VkKeyboard(one_time=True)
                                keyboard.add_button(f'–ù–∞—á–∞—Ç—å', color= VkKeyboardColor.POSITIVE)
                                write_msg(event.user_id, "–Ø –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ù–∞—á–∞—Ç—å", keyboard.get_keyboard())
                            else:
                                write_msg(event.user_id, "–Ø –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ", create_kb("–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —à–∞–≥—É"))

        except Exception as e:
            print(e)
            pass             

if __name__ == "__main__":
    asyncio.run(vk_apply())
