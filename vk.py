import vk_api
from vk_api.keyboard import VkKeyboard, VkKeyboardColor
from vk_api.longpoll import VkLongPoll, VkEventType
from environs import Env
from DBSM import db_check, user_step_change, all_user
from aiogram import Bot
import asyncio




async def vk_apply():

    env = Env()
    env.read_env(".env")
    token = env.str("API_KEY")
    bot_token = env.str("BOT_TOKEN")
    bot = Bot(token=bot_token, parse_mode = 'HTML')

    def write_msg(user_id, message, kb):
        vk.method('messages.send', {'user_id': user_id, 'message': message, "random_id": 0, "keyboard": kb})

    def create_kb(text):
        keyboard = VkKeyboard(one_time=True)
        keyboard.add_button(f'{text}', color= VkKeyboardColor.POSITIVE)
        return keyboard.get_keyboard()

    # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
    vk = vk_api.VkApi(token=token)
    api = vk.get_api()

    # –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    longpoll = VkLongPoll(vk)

    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
    for event in longpoll.listen():

        # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if event.type == VkEventType.MESSAGE_NEW:
            if event.to_me:

                request = event.text

                user = api.users.get(user_ids= event.user_id, fields = "screen_name")
                name_short = user[0].get("screen_name")

                if request == "–ù–∞—á–∞—Ç—å":
                    if db_check(name_short):
                        user_step_change(name_short, 2)
                    text = f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {user[0]['first_name']}üëã\n\n–ú—ã —Ä–µ–∫–ª–∞–º–Ω–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Å—Ñ–µ—Ä–µ, –∫–æ—Ç–æ—Ä–æ–µ –¥–∞–µ—Ç —Å–≤–æ–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω.\n\nüí¨ –í—ã –º–æ–∂–µ—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –æ—Ç–∑—ã–≤–∞–º–∏ –æ —Ä–∞–±–æ—Ç–µ —Å –Ω–∞–º–∏, –≤—ã –ª–∏—á–Ω–æ –º–æ–∂–µ—Ç–µ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –ª—é–±—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–æ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞—à–∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤:\nüëâ [link1]\n\n**–ö–∞—Ä—Ç–∏–Ω–∫–∞**"
                    write_msg(event.user_id, text, create_kb("–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—åüë®‚Äçüíª"))

                elif request == "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—åüë®‚Äçüíª":
                    if db_check(name_short):
                        user_step_change(name_short, 3)
                    text = "–ö–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —É–∂–µ –°–ï–ì–û–î–ù–Øüëá\n\nüìç –°—É—Ç—å –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏:\n\n‚Äî –í—ã –æ—Ñ–æ—Ä–º–ª—è–π—Ç–µ –ë–ï–°–ü–õ–ê–¢–ù–´–ï –ø—Ä–æ–¥—É–∫—Ç—ã –±–∞–Ω–∫–∞, –ø–æ –Ω–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ.\n‚Äî –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ–±–µ—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–∏, –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –∑–∞–∫–∞–∑–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Å—Ç—É–ø–∏—Ç –≤–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.\n‚Äî –í—ã –Ω–∏—á–µ–º –Ω–µ —Ä–∏—Å–∫—É–π—Ç–µ –∏ –Ω–∏–∫–∞–∫–∏—Ö –≤–ª–æ–∂–µ–Ω–∏–π.\n\n–ë–∞–Ω–∫–∏ –ø–ª–∞—Ç—è—Ç, —á—Ç–æ–±—ã –≤—ã –∑–∞–≤–µ–ª–∏ –∏—Ö –¥–µ–±–µ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É, –∞ –º—ã –¥–µ–ª–∏–º—Å—è —Å –í–∞–º–∏!üí∂\n\n–û–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É –≤ –¥–µ–Ω—å –ø–æ–ª—É—á–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –ø–µ—Ä–µ–≤–æ–¥–æ–º!\n\n–í—ã –ø–æ–ª—É—á–∞–π—Ç–µ –æ–ø–ª–∞—Ç—É –æ—Ç 500‚ÇΩ - 15 000‚ÇΩ, –ø–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –ª—é–±–æ–π –±–∞–Ω–∫, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª-–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.\n\n–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Å 8:00 - 22:00 –ø–æ –ú–°–ö!\n\n‚úÖ –õ–µ–≥–∞–ª—å–Ω–∞—è –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –±–∞–Ω–∫–æ–≤ –†–§!"
                    write_msg(event.user_id, text, create_kb("–î–∞–ª–µ–µ"))

                elif request == "–î–∞–ª–µ–µ":
                    if db_check(name_short):
                        user_step_change(name_short, 4)
                    text = "üì≤‚öí–ß—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ–ª–∞—Ç—å:\n\n1) –ó–∞–∫–∞–∑–∞—Ç—å –ø–æ –Ω–∞—à–∏–º —Å—Å—ã–ª–∫–∞–º –ë–ï–°–ü–õ–ê–¢–ù–´–ï –¥–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã;\n2) –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—ã –≤ —É–¥–æ–±–Ω–æ–º –º–µ—Å—Ç–µ (–¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º –∏–ª–∏ –ø–æ –ª—é–±–æ–º—É —É–¥–æ–±–Ω–æ–º—É –∞–¥—Ä–µ—Å—É);\n3) –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—ã –∏ —Å–æ–æ–±—â–∏—Ç—å –Ω–∞–º;\n4) –ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω–µ–∂–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ!üí∂\n\n–ì–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? –ú—ã —É–∂–µ –ø–æ–¥–æ–±—Ä–∞–ª–∏ –¥–ª—è –í–∞—Å –ø–µ—Ä–≤—ã–µ –∑–∞–¥–∞–Ω–∏—èüëá"
                    write_msg(event.user_id, text, create_kb("–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è"))

                elif request == "–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è":
                    if db_check(name_short):
                        user_step_change(name_short, 5)
                    text = "–û—Ç–ª–∏—á–Ω–æ!\n\n–í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–πüëá\n\n–ß–µ–º –±–æ–ª—å—à–µ –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç - —Ç–µ–º –±–æ–ª—å—à–µ –æ–ø–ª–∞—Ç–∞.\n\n‚ö† –ó–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Ö –±–∞–Ω–∫–æ–≤, –∫–ª–∏–µ–Ω—Ç–æ–º –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∏, –∏–Ω–∞—á–µ –æ–ø–ª–∞—Ç—É –Ω–µ –ø–æ–ª—É—á–∏—Ç—å!‚ö†\n\n[–°–ü–ò–°–û–ö –û–§–§–ï–†–û–í]\n\nüëâ –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∫–∞—Ä—Ç, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É '–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞' –Ω–∏–∂–µ;\n‚Ü™ –î–∞–ª–µ–µ –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–¥–∞–Ω–∏—è–º!\n\n‚ùì–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º [link2]"
                    write_msg(event.user_id, text, create_kb("–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞"))

                elif request == "–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞":
                    if db_check(name_short):
                        user_step_change(name_short, 6)
                    text = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞, –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞–º –≤—ã–ø–ª–∞—Ç—É —Å—Ä–µ–¥—Å—Ç–≤, –≤ —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä üë®‚Äçüíª\n\n‚ùó–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ, —á—Ç–æ –∫–∞—Ä—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω–∞ –∏ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞‚ùó\n\n–ï—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è —Å–æ–±–ª—é–¥–µ–Ω—ã, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞'üëá"
                    write_msg(event.user_id, text, create_kb("–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞"))
                
                elif request == "–û–∂–∏–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞":
                    await bot.send_message(chat_id = 398346500, text= f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{name_short} –æ–∂–∏–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞")
                    if db_check(name_short):
                        user_step_change(name_short, 10)
                elif request == "/admin":
                    if name_short == "madriot" or name_short == "egorkjj":
                        res = all_user()
                        text = ""
                        for i in res:
                            step = f"—à–∞–≥ {i['step']}" if i['step'] != 10 else "–¥–æ—à–µ–ª –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —à–∞–≥–∞"
                            text += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {i['user']}: {step}\n"
                        write_msg(event.user_id, text, None)
                

if __name__ == "__main__":
    asyncio.run(vk_apply())